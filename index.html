<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checklist</title>
  <style>
    body {margin:0;font-family:sans-serif;background:#fff;color:#000;display:flex;height:100vh;transition:background .3s,color .3s}
    body.dark{background:#1a1a1a;color:#e0e0e0}
    .sidebar{width:240px;background:#fff;border-right:1px solid #000;padding:1rem;display:flex;flex-direction:column;transition:background .3s,border-color .3s}
    body.dark .sidebar{background:#2a2a2a;border-right:1px solid #444}
    .lists{flex:1;overflow-y:auto;margin-bottom:1rem}
    .list-item{padding:.5rem;border-radius:4px;cursor:pointer;transition:background .2s}
    .list-item.active{background:#f0f0f0}
    body.dark .list-item.active{background:#3a3a3a}
    .main{flex:1;padding:1.5rem;overflow-y:auto;display:flex;flex-direction:column}
    .header{display:flex;gap:.5rem;align-items:center;margin-bottom:1rem}
    .list-title{font-size:1.5rem;font-weight:bold;outline:none;flex:1}
    .theme-toggle{padding:.4rem .6rem;border:1px solid #000;border-radius:4px;background:#fff;cursor:pointer;font-size:14px}
    body.dark .theme-toggle{border-color:#666;background:#2a2a2a;color:#e0e0e0}
    .controls{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
    .input-row{display:flex;gap:.5rem;margin-bottom:1rem}
    .input-row input{flex:1;padding:.5rem;border:1px solid #000;border-radius:4px;background:#fff;color:#000}
    body.dark .input-row input{border-color:#666;background:#2a2a2a;color:#e0e0e0}
    .search-box{padding:.5rem;border:1px solid #000;border-radius:4px;margin-bottom:1rem;background:#fff;color:#000}
    body.dark .search-box{border-color:#666;background:#2a2a2a;color:#e0e0e0}
    .btn{padding:.5rem .75rem;border:1px solid #000;border-radius:4px;background:#fff;cursor:pointer;transition:background .2s;white-space:nowrap}
    .btn:hover{background:#f5f5f5}
    body.dark .btn{border-color:#666;background:#2a2a2a;color:#e0e0e0}
    body.dark .btn:hover{background:#3a3a3a}
    .btn.active{background:#e0e0e0}
    body.dark .btn.active{background:#4a4a4a}
    .task{display:flex;align-items:center;gap:.5rem;background:#fff;border:1px solid #000;border-radius:4px;padding:.5rem;margin-bottom:.5rem;transition:background .2s,border-color .2s}
    body.dark .task{background:#2a2a2a;border-color:#444}
    .task-wrapper{margin-left:0;position:relative}
    .task.priority-high{border-left:4px solid #ef4444}
    .task.priority-medium{border-left:4px solid #f59e0b}
    .task.priority-low{border-left:4px solid #3b82f6}
    .handle{cursor:grab;color:#000;flex-shrink:0}
    body.dark .handle{color:#999}
    .collapse-btn{background:none;border:none;cursor:pointer;font-size:12px;padding:0 4px;flex-shrink:0;color:#000}
    body.dark .collapse-btn{color:#999}
    .checkbox{width:18px;height:18px;border:1px solid #000;border-radius:2px;display:grid;place-items:center;cursor:pointer;flex-shrink:0}
    body.dark .checkbox{border-color:#666}
    .checkbox.checked::after{content:"âœ”";font-size:14px}
    .task-content{flex:1;outline:none;min-width:0}
    .task.completed .task-content{text-decoration:line-through;color:#888}
    .task-meta{display:flex;gap:.5rem;align-items:center;font-size:12px;color:#666;flex-shrink:0}
    .due-date{padding:2px 6px;border-radius:3px;background:#f0f0f0;white-space:nowrap}
    body.dark .due-date{background:#3a3a3a}
    .due-date.overdue{background:#fee;color:#c00}
    body.dark .due-date.overdue{background:#4a2020;color:#ff6b6b}
    .due-date.soon{background:#fef3c7;color:#92400e}
    body.dark .due-date.soon{background:#3a3520;color:#fbbf24}
    .progress{font-size:11px;color:#666}
    .tag{padding:2px 6px;border-radius:3px;background:#e0e0e0;font-size:11px;color:#333}
    body.dark .tag{background:#3a3a3a;color:#bbb}
    .icon-btn{background:none;border:none;cursor:pointer;font-size:16px;line-height:1;padding:0 4px;flex-shrink:0;color:#666}
    .icon-btn:hover{color:#000}
    body.dark .icon-btn:hover{color:#e0e0e0}
    .indent-btn{background:none;border:none;cursor:pointer;font-size:16px;line-height:1;padding:0 4px;flex-shrink:0;color:#666}
    .indent-btn:hover{color:#000}
    body.dark .indent-btn:hover{color:#e0e0e0}
    .trash{background:none;border:none;cursor:pointer;font-size:18px;line-height:1;flex-shrink:0;color:#666}
    .trash:hover{color:#c00}
    .dragging{opacity:.5}
    .collapsed{display:none}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal.active{display:flex}
    .modal-content{background:#fff;padding:1.5rem;border-radius:8px;min-width:300px;max-width:500px}
    body.dark .modal-content{background:#2a2a2a}
    .modal-content h3{margin-top:0}
    .modal-content label{display:block;margin-bottom:.5rem;font-weight:bold}
    .modal-content input,.modal-content select,.modal-content textarea{width:100%;padding:.5rem;border:1px solid #000;border-radius:4px;margin-bottom:1rem;background:#fff;color:#000}
    body.dark .modal-content input,body.dark .modal-content select,body.dark .modal-content textarea{border-color:#666;background:#1a1a1a;color:#e0e0e0}
    .modal-content textarea{min-height:80px;resize:vertical;font-family:sans-serif}
    .modal-buttons{display:flex;gap:.5rem;justify-content:flex-end}
    .undo-redo{display:flex;gap:.25rem}
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Lists</h2>
    <div id="lists" class="lists"></div>
    <button id="newListBtn" class="btn">ï¼‹ New list</button>
    <button id="deleteListBtn" class="btn">Ã— Delete list</button>
    <div style="margin-top:1rem">
      <button id="exportBtn" class="btn" style="width:100%;margin-bottom:.5rem">Export</button>
      <button id="importBtn" class="btn" style="width:100%">Import</button>
      <input type="file" id="importFile" style="display:none" accept=".json">
    </div>
  </aside>
  <main class="main">
    <div class="header">
      <div contenteditable="true" id="listTitle" class="list-title"></div>
      <button id="themeToggle" class="theme-toggle">ðŸŒ™</button>
    </div>
    <input type="text" id="searchBox" class="search-box" placeholder="Search tasks or filter by #tag..." />
    <div class="controls">
      <div class="undo-redo">
        <button id="undoBtn" class="btn" title="Undo">â†¶</button>
        <button id="redoBtn" class="btn" title="Redo">â†·</button>
      </div>
      <button id="filterAll" class="btn active">All</button>
      <button id="filterActive" class="btn">Active</button>
      <button id="filterCompleted" class="btn">Completed</button>
      <button id="filterHigh" class="btn">High</button>
      <button id="filterMedium" class="btn">Medium</button>
      <button id="filterLow" class="btn">Low</button>
    </div>
    <div class="input-row">
      <input id="taskInput" type="text" placeholder="Add a taskâ€¦ (use #tags)" />
      <button id="addTaskBtn" class="btn">ï¼‹</button>
    </div>
    <div id="tasks"></div>
  </main>

  <div id="taskModal" class="modal">
    <div class="modal-content">
      <h3>Task Details</h3>
      <label>Priority</label>
      <select id="modalPriority">
        <option value="">None</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
      <label>Due Date</label>
      <input type="date" id="modalDueDate" />
      <label>Notes</label>
      <textarea id="modalNotes" placeholder="Add notes..."></textarea>
      <div class="modal-buttons">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalSave" class="btn">Save</button>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = "checklistData.v7";
let state = { lists: [], activeId: null, theme: 'light', filter: 'all', search: '' };
let history = { past: [], future: [] };
let currentModalTaskId = null;

function uid(){return Math.random().toString(36).slice(2,9);}
function save(){localStorage.setItem(STORAGE_KEY, JSON.stringify(state));}
function load(){try{const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):null;}catch{return null;}}

function saveHistory(){
  history.past.push(JSON.parse(JSON.stringify(state)));
  if(history.past.length>50)history.past.shift();
  history.future=[];
}

function undo(){
  if(history.past.length===0)return;
  history.future.push(JSON.parse(JSON.stringify(state)));
  state=history.past.pop();
  save();refreshUI();
}

function redo(){
  if(history.future.length===0)return;
  history.past.push(JSON.parse(JSON.stringify(state)));
  state=history.future.pop();
  save();refreshUI();
}

function init(){
  const data=load();
  if(data && Array.isArray(data.lists)){
    state=data;
    if(!state.theme)state.theme='light';
    if(!state.filter)state.filter='all';
    if(!state.search)state.search='';
  }
  else{
    const first={id:uid(),name:"My Tasks",tasks:[]};
    state.lists=[first];state.activeId=first.id;state.theme='light';state.filter='all';state.search='';save();
  }
  document.body.className=state.theme==='dark'?'dark':'';
  document.getElementById('themeToggle').textContent=state.theme==='dark'?'â˜€ï¸':'ðŸŒ™';
  document.getElementById('searchBox').value=state.search||'';
  refreshUI();
}

function getActiveList(){return state.lists.find(l=>l.id===state.activeId);}

function refreshUI(){
  renderLists();
  renderActiveList();
  updateFilterButtons();
}

function updateFilterButtons(){
  ['filterAll','filterActive','filterCompleted','filterHigh','filterMedium','filterLow'].forEach(id=>{
    document.getElementById(id).classList.remove('active');
  });
  const map={all:'filterAll',active:'filterActive',completed:'filterCompleted',high:'filterHigh',medium:'filterMedium',low:'filterLow'};
  if(map[state.filter])document.getElementById(map[state.filter]).classList.add('active');
}

function renderLists(){
  const listsEl=document.getElementById("lists");
  listsEl.innerHTML="";
  state.lists.forEach(list=>{
    const el=document.createElement("div");
    el.className="list-item"+(list.id===state.activeId?" active":"");
    el.textContent=list.name;
    el.onclick=()=>{state.activeId=list.id;save();refreshUI();};
    listsEl.appendChild(el);
  });
}

function extractTags(text){
  const matches=text.match(/#\w+/g);
  return matches?matches.map(t=>t.toLowerCase()):[];
}

function matchesFilter(task){
  if(state.filter==='active'&&task.completed)return false;
  if(state.filter==='completed'&&!task.completed)return false;
  if(state.filter==='high'&&task.priority!=='high')return false;
  if(state.filter==='medium'&&task.priority!=='medium')return false;
  if(state.filter==='low'&&task.priority!=='low')return false;
  if(state.search){
    const s=state.search.toLowerCase();
    const textMatch=task.text.toLowerCase().includes(s);
    const tagMatch=s.startsWith('#')&&task.tags&&task.tags.some(t=>t.includes(s));
    if(!textMatch&&!tagMatch)return false;
  }
  return true;
}

function getChildren(task,allTasks){
  const idx=allTasks.indexOf(task);
  const children=[];
  for(let i=idx+1;i<allTasks.length;i++){
    if((allTasks[i].level||0)<=(task.level||0))break;
    children.push(allTasks[i]);
  }
  return children;
}

function hasChildren(task,allTasks){
  return getChildren(task,allTasks).length>0;
}

function getProgress(task,allTasks){
  const children=getChildren(task,allTasks).filter(c=>(c.level||0)===(task.level||0)+1);
  if(children.length===0)return null;
  const completed=children.filter(c=>c.completed).length;
  return {completed,total:children.length};
}

function renderActiveList(){
  const list=getActiveList();if(!list)return;
  document.getElementById("listTitle").textContent=list.name;
  const tasksEl=document.getElementById("tasks");tasksEl.innerHTML="";
  
  let skipUntilLevel=null;
  list.tasks.forEach(task=>{
    if(skipUntilLevel!==null&&(task.level||0)>skipUntilLevel)return;
    skipUntilLevel=null;
    
    if(!matchesFilter(task))return;
    
    if(task.collapsed){
      skipUntilLevel=task.level||0;
    }
    
    tasksEl.appendChild(taskView(task,list.tasks));
  });
}

function getDueDateClass(dueDate){
  if(!dueDate)return '';
  const due=new Date(dueDate);
  const now=new Date();
  now.setHours(0,0,0,0);
  const diff=Math.ceil((due-now)/(1000*60*60*24));
  if(diff<0)return 'overdue';
  if(diff<=3)return 'soon';
  return '';
}

function taskView(task,allTasks){
  const wrapper=document.createElement("div");
  wrapper.className="task-wrapper";
  wrapper.dataset.id=task.id;
  wrapper.style.marginLeft=(task.level||0)*2+"rem";

  const row=document.createElement("div");
  row.className="task"+(task.completed?" completed":"")+(task.priority?" priority-"+task.priority:"");
  row.draggable=true;

  const collapseBtn=document.createElement("button");
  collapseBtn.className="collapse-btn";
  const hasKids=hasChildren(task,allTasks);
  collapseBtn.textContent=hasKids?(task.collapsed?"â–¶":"â–¼"):"";
  collapseBtn.onclick=()=>{
    if(!hasKids)return;
    saveHistory();
    task.collapsed=!task.collapsed;
    save();refreshUI();
  };

  const handle=document.createElement("div");handle.className="handle";handle.textContent="â‹®â‹®";
  
  const checkbox=document.createElement("div");checkbox.className="checkbox"+(task.completed?" checked":"");
  checkbox.onclick=()=>{
    saveHistory();
    task.completed=!task.completed;
    const children=getChildren(task,allTasks);
    children.forEach(c=>c.completed=task.completed);
    save();refreshUI();
  };

  const content=document.createElement("div");content.className="task-content";content.contentEditable=true;
  content.innerText=task.text;
  content.oninput=()=>{
    saveHistory();
    task.text=content.innerText.trim();
    task.tags=extractTags(task.text);
    save();
  };
  content.onkeydown=e=>{if(e.key==="Enter"){e.preventDefault();content.blur();}};

  const meta=document.createElement("div");meta.className="task-meta";
  
  const prog=getProgress(task,allTasks);
  if(prog){
    const progress=document.createElement("span");
    progress.className="progress";
    progress.textContent=`${prog.completed}/${prog.total}`;
    meta.appendChild(progress);
  }
  
  if(task.dueDate){
    const due=document.createElement("span");
    due.className="due-date "+getDueDateClass(task.dueDate);
    due.textContent=new Date(task.dueDate).toLocaleDateString();
    meta.appendChild(due);
  }
  
  if(task.tags&&task.tags.length>0){
    task.tags.forEach(tag=>{
      const tagEl=document.createElement("span");
      tagEl.className="tag";
      tagEl.textContent=tag;
      meta.appendChild(tagEl);
    });
  }

  const noteBtn=document.createElement("button");
  noteBtn.className="icon-btn";
  noteBtn.textContent=task.notes?"ðŸ“":"ðŸ“„";
  noteBtn.title="Edit details";
  noteBtn.onclick=()=>openModal(task.id);

  const outdentBtn=document.createElement("button");outdentBtn.className="indent-btn";outdentBtn.textContent="â†";
  outdentBtn.onclick=()=>{
    saveHistory();
    task.level=Math.max(0,(task.level||0)-1);
    save();refreshUI();
  };

  const indentBtn=document.createElement("button");indentBtn.className="indent-btn";indentBtn.textContent="â†’";
  indentBtn.onclick=()=>{
    saveHistory();
    const list=getActiveList();
    const idx=list.tasks.findIndex(t=>t.id===task.id);
    if(idx>0){
      task.level=(task.level||0)+1;
      if(task.level>5)task.level=5;
      save();refreshUI();
    }
  };

  const trash=document.createElement("button");trash.className="trash";trash.textContent="Ã—";
  trash.onclick=()=>{
    saveHistory();
    const list=getActiveList();
    list.tasks=list.tasks.filter(t=>t.id!==task.id);
    save();refreshUI();
  };

  row.append(collapseBtn,handle,checkbox,content,meta,noteBtn,outdentBtn,indentBtn,trash);
  wrapper.appendChild(row);

  wrapper.addEventListener("dragstart",e=>{wrapper.classList.add("dragging");e.dataTransfer.setData("text/plain",task.id);});
  wrapper.addEventListener("dragend",()=>wrapper.classList.remove("dragging"));

  return wrapper;
}

function openModal(taskId){
  const list=getActiveList();
  const task=list.tasks.find(t=>t.id===taskId);
  if(!task)return;
  currentModalTaskId=taskId;
  document.getElementById('modalPriority').value=task.priority||'';
  document.getElementById('modalDueDate').value=task.dueDate||'';
  document.getElementById('modalNotes').value=task.notes||'';
  document.getElementById('taskModal').classList.add('active');
}

function closeModal(){
  document.getElementById('taskModal').classList.remove('active');
  currentModalTaskId=null;
}

document.getElementById('modalSave').onclick=()=>{
  if(!currentModalTaskId)return;
  saveHistory();
  const list=getActiveList();
  const task=list.tasks.find(t=>t.id===currentModalTaskId);
  if(task){
    task.priority=document.getElementById('modalPriority').value||null;
    task.dueDate=document.getElementById('modalDueDate').value||null;
    task.notes=document.getElementById('modalNotes').value||null;
    save();refreshUI();
  }
  closeModal();
};

document.getElementById('modalCancel').onclick=closeModal;

// Drag reorder
const tasksEl=document.getElementById("tasks");
tasksEl.addEventListener("dragover",e=>{
  e.preventDefault();
  const dragging=document.querySelector(".dragging");
  if(!dragging)return;
  const after=getDragAfterElement(tasksEl,e.clientY);
  if(after==null)tasksEl.appendChild(dragging);
  else tasksEl.insertBefore(dragging,after);
});
tasksEl.addEventListener("drop",()=>{
  saveHistory();
  const list=getActiveList();
  const order=Array.from(tasksEl.children).map(el=>el.dataset.id);
  list.tasks.sort((a,b)=>order.indexOf(a.id)-order.indexOf(b.id));
  save();refreshUI();
});
function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll(".task-wrapper:not(.dragging)")];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0 && offset>closest.offset)return{offset,element:child};
    else return closest;
  },{offset:-Infinity}).element;
}

// Events
document.getElementById("addTaskBtn").onclick=addTaskFromInput;
document.getElementById("taskInput").onkeydown=e=>{if(e.key==="Enter")addTaskFromInput();};
document.getElementById("listTitle").oninput=()=>{
  const list=getActiveList();list.name=document.getElementById("listTitle").innerText.trim()||"Untitled";
  save();renderLists();
};
document.getElementById("newListBtn").onclick=()=>{
  saveHistory();
  const newList={id:uid(),name:"New list",tasks:[]};
  state.lists.push(newList);state.activeId=newList.id;save();refreshUI();
};
document.getElementById("deleteListBtn").onclick=()=>{
  const current=getActiveList();
  if(!current) return;
  if(state.lists.length===1 && current.id===state.lists[0].id){
    alert("You need at least one list.");
    return;
  }
  const confirmed=confirm(`Delete list "${current.name}"? This cannot be undone.`);
  if(!confirmed) return;
  saveHistory();
  state.lists=state.lists.filter(l=>l.id!==current.id);
  state.activeId=state.lists[0].id;
  save();refreshUI();
};

document.getElementById('themeToggle').onclick=()=>{
  state.theme=state.theme==='dark'?'light':'dark';
  document.body.className=state.theme==='dark'?'dark':'';
  document.getElementById('themeToggle').textContent=state.theme==='dark'?'â˜€ï¸':'ðŸŒ™';
  save();
};

document.getElementById('undoBtn').onclick=undo;
document.getElementById('redoBtn').onclick=redo;

document.getElementById('filterAll').onclick=()=>{state.filter='all';save();refreshUI();};
document.getElementById('filterActive').onclick=()=>{state.filter='active';save();refreshUI();};
document.getElementById('filterCompleted').onclick=()=>{state.filter='completed';save();refreshUI();};
document.getElementById('filterHigh').onclick=()=>{state.filter='high';save();refreshUI();};
document.getElementById('filterMedium').onclick=()=>{state.filter='medium';save();refreshUI();};
document.getElementById('filterLow').onclick=()=>{state.filter='low';save();refreshUI();};

document.getElementById('searchBox').oninput=(e)=>{
  state.search=e.target.value;
  save();refreshUI();
};

document.getElementById('exportBtn').onclick=()=>{
  const dataStr=JSON.stringify(state,null,2);
  const blob=new Blob([dataStr],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='checklist-export.json';
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('importBtn').onclick=()=>{
  document.getElementById('importFile').click();
};

document.getElementById('importFile').onchange=(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=(evt)=>{
    try{
      const imported=JSON.parse(evt.target.result);
      if(imported.lists&&Array.isArray(imported.lists)){
        saveHistory();
        state=imported;
        save();
        init();
        alert('Import successful!');
      }else{
        alert('Invalid file format.');
      }
    }catch(err){
      alert('Error reading file: '+err.message);
    }
  };
  reader.readAsText(file);
};

function addTaskFromInput(){
  const input=document.getElementById("taskInput");
  const text=input.value.trim();if(!text)return;
  saveHistory();
  const list=getActiveList();
  const tags=extractTags(text);
  list.tasks.push({id:uid(),text,completed:false,level:0,tags});
  input.value="";save();refreshUI();
}

init();
</script>
</body>
</html>